---
# https://www.siberoloji.com/how-to-stream-audio-with-obs-on-arch-linux/
#
- name: "{{ ansible_facts['distribution'] }} | Install audio packages"
  community.general.pacman:
    name:
      - pipewire
      - pipewire-audio
      - pipewire-jack
      - pipewire-pulse
      # - pipewire-v4l2
      - wireplumber
      # - lib32-pipewire
      # - lib32-pipewire-jack
      # - lib32-pipewire-v4l2
      - pavucontrol
      - easyeffects
      - lsp-plugins
      - lsp-plugins-lv2
      # - helvum # JACK-like routing | graphical PipeWire patchbay
    state: present
  become: true

- name: "{{ ansible_facts['distribution'] }} | Enable pipewire service"
  ansible.builtin.systemd:
    name: pipewire.service
    enabled: true
    scope: user

- name: "{{ ansible_facts['distribution'] }} | Enable wireplumber service"
  ansible.builtin.systemd:
    name: wireplumber.service
    enabled: true
    scope: user


- name: "{{ ansible_facts['distribution'] }} | Hide lsp_plugins .desktop files"
  community.general.ini_file:
    path: "{{ item }}"
    section: "Desktop Entry"
    option: "Hidden"
    value: "true"
    no_extra_spaces: yes
  with_fileglob:
    - /usr/share/applications/*lsp_plug*.desktop
  when: lookup('file', item) is not search('Hidden=')
  become: yes

- name: "{{ ansible_facts['distribution'] }} | Find .desktop files containing Avahi"
  shell: grep -l "Avahi" /usr/share/applications/*.desktop 2>/dev/null || true
  register: avahi_desktop_files
  changed_when: false

- name: "{{ ansible_facts['distribution'] }} | Hide Avahi .desktop files"
  community.general.ini_file:
    path: "{{ item }}"
    section: "Desktop Entry"
    option: "Hidden"
    value: "true"
    no_extra_spaces: yes
  loop: "{{ avahi_desktop_files.stdout_lines }}"
  when: avahi_desktop_files.stdout_lines | length > 0 and lookup('file', item) is not search('Hidden=')
  become: yes


